<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
		#wrapper{
            width: 290px;
            margin: 5px;
            float:left;
            border-radius: 10px 10px 10px 10px;
		}

		#shadow{
			margin-bottom: 10px;
		}

		#shadow :hover{
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
        }

        #product{
            width: 290px;
            padding: 20px 25px;
            color: #555555
        }

        #product :hover{
            box-shadow: 0 0 0 rgba(0, 0, 0, 0.3);
        }

        #product :active{
            color: #555555;
            text-decoration: none;
        }

        #product :visited{
            color: #555555;
            text-decoration: none;
        }

        .product-img{
            padding-top: 10px;
            width: 240px;
            text-align: center;
            background-color: white;
        }

        .product-img img{
            height: 200px;
        }

        .product-info{
            width: 210px;
            height: 100px;
			margin: 0px 15px;
            padding: 10px 0px;
            background-color: white;
        }

        .product-info p{
            width: 220px;
            text-align: left;
			font-size: 14px;
        }

		#brand{
			margin-bottom: 5px;
		}

/*sns*/
        #sns {
            height: 50px;
            padding: 10px 15px;
            background-color: white;
        }

        #sns div{
            width: 60px;
            float:left; 
            padding-right: 8px;
        }

        #sns div img{
            height: 20px;
            float:left; 
            padding-right: 5px;
        }

        #sns img :hover{
            opacity: 1.0;
        }

/*page*/
        #pageW{
            text-align: center;
            margin: 0px auto;
            padding: 20px 0px;
            width:1304px;
            overflow: hidden;
            border-left: 2px solid #dddddd;
            border-right: 2px solid #dddddd;
        }

        #page{
			height:30px;
            margin: 20px 550px;
			background-color: white;
        }

        #page div{
            color: #aaaaaa;
            width: 30px;
            height: 30px;
            float: left;
            margin: 0px 5px;
        }

        #page div :hover{
            color: #aaaaaa;
            border-bottom: 2px solid #aaaaaa;
        }

        #page div :visited{
            color: #aaaaaa;
            text-decoration: none;
        }

        #page div :active{
            color: #aaaaaa;
            text-decoration: none;
        }

        #page #after{
            background-color: #aaaaaa;
            color: white;
        }

        #page #after :hover{
            background-color: #aaaaaa;
            color: white;
        }

        /**/
        #footer{
            width:100%;
            height:80px;
            text-align: center;
            padding-top:8px;
            background-color: #4285f4; 
            color: white;
        }

    </style>
</head>
<body>
    <% include ./templates/header %>
    <div>
        <!--content&pageW 위에 div 생성-->
        <div id="content">
            <% viewData.forEach(function(data){ %>
            <div id="wrapper">
                <div id="shadow">
                    <a href="product/<%= data.p_id %>">
                        <div id="product">
                            <div class="product-img">
                                <img src="<%= data.p_image %>">
                            </div>
                            <div class="product-info">
                                    <p id="brand"><span><%= data.p_brand %></span></p>
                                    <p><span><%= data.p_name %></span></p>
                                    <p><span>53,900원</span></p>
                            </div>
                        </div>
                    </a>
                </div>
                <div id="sns">
                    <div>
                        <a href="javascript:void(0);" onclick="handleLike(this,'<%- data.p_id %>')">
                            <img src="public/image/good.png">
                        </a>
                        <!--페이지가 초기 출력될 때, DB에서 받아온 값을 전달해야 함-->
                        <p><%= data.count_like %></p>
                        
                    </div>
                    <div>
                        <a href="javascript:void(0);" onclick="handleLike(this,'<%- data.p_id %>')">
                            <img src="public/image/bad.png"></a>
                        <p><%= data.count_unlike %></p>
                    </div>
                    <div>
                        <a href=""><img src="public/image/comment.png"></a>
                        <p>4</p>
                    </div>
                </div>
            </div>
            <% }) %>
        </div>
    </div>

    <div id="pageW">
        <div id="page">
            <a id="1" href="/product?page=1"><div><h3>1</h3></div></a>
            <a id="2" href="/product?page=2"><div><h3>2</h3></div></a>
            <a id="3" href="/product?page=3"><div><h3>3</h3></div></a>
            <a id="4" href="/product?page=4"><div><h3>4</h3></div></a>
            <a id="5" href="/product?page=5"><div><h3>5</h3></div></a>
        </div>
    </div> 
    <%- include('templates/login',{loginInfo:loginInfo}) %>

    <script>
        const pageNum="<%- pageNum %>";
        const activePage=document.getElementById(pageNum);
        
        activePage.childNodes[0].id="after"

        function handleLike(element,data){
            if(!'<%- loginInfo.loginStatus %>'){
                alert("로그인이 필요한 서비스입니다!");
                return;
            }
            const p_id=data;
            const xhttp=new XMLHttpRequest();
            const url=`/like/${p_id}`;

            xhttp.open('GET',url,true);
            xhttp.onreadystatechange=()=>{
                if(xhttp.readyState===4&&xhttp.status===200){
                    const response=JSON.parse(xhttp.responseText);
                    console.log(response);

                    if(response.isLike===false){
                        element.children[0].style.opacity=0.3;
                    }else if(response.isLike===true){
                        element.children[0].style.opacity=1.0;
                    }

                    //Parent Node의 두번째 자식인 p태그 내에 Parameter로 넘어온 COUNT값을 넣음
                    element.parentNode.children[1].innerHTML=response.COUNT;
                }
            }
            xhttp.send();
        }

        function handleUnlike(element,data){
            const p_id=data;
            const xhttp=new XMLHttpRequest();
            const url=`/unlike/${p_id}`;

            xhttp.open('GET',url,true);
            xhttp.onreadystatechange=()=>{
                if(xhttp.readyState===4&&xhttp.status===200){
                    const response=JSON.parse(xhttp.responseText);
                    console.log(response);

                    if(response.isUnLike===false){
                        element.children[0].style.opacity=0.3;
                    }else if(response.isUnlike===true){
                        element.children[0].style.opacity=1.0;
                    }
                    //Parent Node의 두번째 자식인 p태그 내에 Parameter로 넘어온 COUNT값을 넣음
                    element.parentNode.children[1].innerHTML=response.COUNT;
                }
            }
            xhttp.send();
        }
    </script>
</body>
</html>